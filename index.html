<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Designftw Chatroom</title>
    <script type="importmap">
      {
        "imports": {
          "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
          "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
          "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs",
          "@graffiti-garden/wrapper-files": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-files@0.0.1/dist/browser/index.js",
          "@graffiti-garden/wrapper-files/vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-files@0.0.1/dist/vue/index.mjs"
        }
      }
    </script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <h1>ChatRoom</h1>

      <button v-if="!$graffitiSession.value" @click="$graffiti.login()">
        Log In
      </button>
      <template v-else>
        <button v-if="$graffitiSession.value" @click="doLogout">Log Out</button>
        <p>Logged in as: {{ $graffitiSession.value.actor }}</p>

        <div v-if="myProfile" class="my-profile">
          <h2>My Profile</h2>
          <graffiti-get
            v-if="profilePictureUrl"
            :url="profilePictureUrl"
            :schema="graffitiFileSchema"
            v-slot="{ object }"
          >
            <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
              <img
                :src="fileDataUrl"
                alt="Profile picture"
                class="profile-picture"
              />
            </graffiti-object-to-file>
          </graffiti-get>
          <p><strong>Name:</strong> {{ myProfile.name }}</p>
          <p v-if="myProfile.pronouns">
            <strong>Pronouns:</strong> {{ myProfile.pronouns }}
          </p>
          <p v-if="privateProfile && privateProfile.age">
            <strong>Age:</strong> {{ privateProfile.age }}
          </p>
          <p v-if="privateProfile && privateProfile.location">
            <strong>Location:</strong> {{ privateProfile.location }}
          </p>
        </div>

        <div v-else class="create-profile">
          <h2>Create Your Profile</h2>
          <form @submit.prevent="createProfile($graffitiSession.value)">
            <input
              type="text"
              v-model="profileName"
              placeholder="Name (required)"
              required
            />
            <input
              type="text"
              v-model="profilePronouns"
              placeholder="Pronouns (optional)"
            />
            <input
              type="text"
              v-model="profileAge"
              placeholder="Age (private)"
            />
            <input
              type="text"
              v-model="profileLocation"
              placeholder="Location (private)"
            />

            <div class="profile-picture-upload">
              <label for="profile-picture-input"
                >Profile Picture (less than 5 MB)</label
              >
              <input
                id="profile-picture-input"
                type="file"
                accept="image/*"
                @change="setFileToUpload"
              />
              <button
                v-if="fileToUpload"
                @click="uploadProfilePicture($graffitiSession.value)"
              >
                Upload Picture
              </button>
            </div>

            <input type="submit" value="Save Profile" />
          </form>
        </div>
      </template>

      <div class="chat-tabs">
        <button
          class="tab"
          :class="{ active: chatType === 'group' }"
          @click="switchToGroupChat"
        >
          Group Chats
        </button>
        <button
          class="tab"
          :class="{ active: chatType === 'direct' }"
          @click="switchToDirectMessages"
        >
          Direct Messages
        </button>
      </div>

      <div class="chat-container">
        <div class="chat-sidebar">
          <div v-show="chatType === 'group'">
            <h2>Group Chats</h2>
            <form @submit.prevent="createGroupChat($graffitiSession.value)">
              <input
                type="text"
                v-model="group"
                placeholder="Group Chat Name"
              />
              <input type="submit" value="Create Group Chat" />
            </form>

            <p v-if="historyLoading" class="loading-message">
              Loading your chat history...
            </p>

            <graffiti-discover
              ref="groupChatsDiscover"
              v-slot="{ objects: groupChatObjects, isInitialPolling }"
              :channels="['designftw']"
              :schema="{
                properties: {
                  value: {
                    required: ['activity','object'],
                    properties: {
                      activity: { const: 'Create' },
                      object: {
                        required: ['type','name','channel'],
                        properties: {
                          type: { const: 'Group Chat' },
                          name: { type: 'string' },
                          channel: { type: 'string' }
                        }
                      }
                    }
                  }
                }
              }"
            >
              <div v-if="isInitialPolling">Loading...</div>
              <ul v-else>
                <li v-for="obj of groupChatObjects" :key="obj.url">
                  <button
                    @click="joinGroupChat(obj)"
                    :class="{ 
                      active: activeChannel === obj.value.object.channel,
                      'previously-joined': joinedGroupChats.includes(obj.value.object.channel)
                    }"
                  >
                    {{ renameObjects.find(r => r.value.describes ===
                    obj.value.object.channel)?.value.name ||
                    obj.value.object.name }}

                    <span
                      v-if="joinedGroupChats.includes(obj.value.object.channel)"
                      class="joined-indicator"
                      title="Previously joined"
                      >✓</span
                    >
                  </button>
                </li>
              </ul>
            </graffiti-discover>
          </div>

          <div v-show="chatType === 'direct'">
            <h2>Direct Messages</h2>
            <div v-if="$graffitiSession.value" class="dm-actions">
              <form
                @submit.prevent="startDirectMessage($graffitiSession.value)"
                class="inline-form"
              >
                <input
                  type="text"
                  v-model="directMessageUser"
                  placeholder="Recipient's User ID"
                />
                <input type="submit" value="Send Message" />
              </form>
            </div>

            <div
              v-if="$graffitiSession.value && dmhis.length"
              class="conversation-history"
            >
              <h3>My Conversations</h3>
              <ul class="conversation-list">
                <li v-for="userId in sortedConversations()" :key="userId">
                  <button
                    @click="
                       openConversation(userId, $graffitiSession.value);
                       showProfile(userId)"
                    :class="{ active: activeChannel === userId }"
                  >
                    {{ userId }}
                    <div class="preview-message" v-if="last[userId]">
                      <small>{{ formatTime(last[userId].timestamp) }}: </small>
                      <span
                        >{{ last[userId].content.slice(0,30) }}{{
                        last[userId].content.length>30?'…':'' }}</span
                      >
                    </div>
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="chat-main">
          <div v-if="activeChannel">
            <div class="chat-header">
              <h2 class="chat-title">Conversation</h2>
              <div
                class="chat-recipient clickable-user"
                @click="toggleProfilePanel(); showProfile(activeChannel)"
              >
                {{ activeChatName }}
              </div>
            </div>

            <div
              v-if="chatType==='direct' && showProfilePanel"
              class="profile-panel"
            >
              <h3>Profile</h3>
              <div v-if="currentProfile">
                <graffiti-get
                  v-if="currentProfile.value.picture"
                  :url="currentProfile.value.picture"
                  :schema="graffitiFileSchema"
                  v-slot="{ object }"
                >
                  <graffiti-object-to-file
                    :object="object"
                    v-slot="{ fileDataUrl }"
                  >
                    <img
                      :src="fileDataUrl"
                      alt="Profile picture"
                      class="profile-picture"
                    />
                  </graffiti-object-to-file>
                </graffiti-get>

                <p><strong>Name:</strong> {{ currentProfile.value.name }}</p>
                <p v-if="currentProfile.value.pronouns">
                  <strong>Pronouns:</strong> {{ currentProfile.value.pronouns }}
                </p>
                <p v-if="privateProfileToShow">
                  <strong>Age:</strong> {{ privateProfileToShow.value.age }}
                </p>
                <p v-if="privateProfileToShow">
                  <strong>Location:</strong> {{
                  privateProfileToShow.value.location }}
                </p>
              </div>
              <div v-else>Profile not created yet.</div>
            </div>
            <graffiti-discover
              v-model:objects="profileObjects"
              :channels="[ activeChannel, `${activeChannel}-private` ]"
              :schema="{
    properties: {
      value: {
        required: ['describes'],
        properties: {
          describes: { type: 'string' },
          name:      { type: 'string' },
          pronouns:  { type: 'string' },
          age:       { type: 'string' },
          location:  { type: 'string' }
        }
      }
    }
  }"
            />

            <div v-if="getPinnedCount()>0" class="pinned-toggle">
              <button @click="togglepinnedMess()" class="toggle-button">
                <span v-if="showPinned">Hide Pinned Messages</span>
                <span v-else
                  >Show Pinned Messages ({{ getPinnedCount() }})</span
                >
              </button>
            </div>

            <div
              v-if="showPinned && getPinnedCount()>0"
              class="pinned-messages"
            >
              <h3>Pinned Messages</h3>
              <ul>
                <li
                  v-for="msg in pinnedMess[activeChannel]"
                  :key="msg.url"
                  class="pinned-message"
                >
                  <div class="message-header">
                    <strong
                      >{{ msg.value.sender || msg.actor }}<span
                        v-if="msg.actor===$graffitiSession.value.actor"
                        >(you)</span
                      ></strong
                    >
                    <span class="timestamp"
                      >{{ formatTime(msg.value.published) }}</span
                    >
                  </div>
                  <div class="message-content">{{ msg.value.content }}</div>
                  <button
                    @click="togglePinMessage(msg,$graffitiSession.value)"
                    class="unpin-button"
                  >
                    Unpin
                  </button>
                </li>
              </ul>
            </div>

            <div v-if="$graffitiSession.value" class="message-form">
              <form @submit.prevent="sendMessage($graffitiSession.value)">
                <fieldset :disabled="sending">
                  <div style="display: flex; gap: 5px">
                    <input
                      type="text"
                      v-model="myMessage"
                      placeholder="Type here..."
                      ref="messageInput"
                      v-focus
                      style="flex: 1"
                    />
                    <input
                      type="submit"
                      :value="sending ? 'Sending…' : 'Send'"
                    />
                  </div>
                </fieldset>
              </form>
            </div>

            <graffiti-discover
              v-slot="{ objects: messageObjects, isInitialPolling }"
              :channels="[activeChannel]"
              :schema="{
            properties: {
              value: {
                required:['content','published'],
                properties:{
                  content:{type:'string'},
                  published:{type:'number'},
                  liked:{ type: 'boolean' }
                }
              }
            }
          }"
              @update:objects="processIncomingMessages($event,$graffitiSession.value)"
            >
              <ul>
                <li v-if="isInitialPolling">Loading messages…</li>
                <li v-else-if="messageObjects.length===0">No messages yet.</li>
                <li
                  v-else
                  v-for="obj in messageObjects
                 .filter(m=>!activeSender||m.value.sender===activeSender)
                 .sort((a,b)=>b.value.published-a.value.published)"
                  :key="obj.url"
                  :class="{ pinned: obj.value.pinned }"
                >
                  <div class="message-header">
                    <strong
                      >{{ obj.value.sender||obj.actor }}<span
                        v-if="obj.actor===$graffitiSession.value.actor"
                        >(you)</span
                      ></strong
                    >
                    <span class="timestamp"
                      >{{ formatTime(obj.value.published) }}</span
                    >
                  </div>
                  <div class="message-content">{{ obj.value.content }}</div>
                  <div class="message-actions">
                    <template v-if="obj.actor===$graffitiSession.value.actor">
                      <button @click="editMessage(obj)">Edit</button>
                      <button @click="deleteMessage(obj)">Delete</button>
                      <button
                        @click="togglePinMessage(obj,$graffitiSession.value)"
                        class="pin-button"
                      >
                        {{ obj.value.pinned?'Unpin':'Pin' }}
                      </button>
                    </template>

                    <template v-else>
                      <button
                        @click="togglePinMessage(obj,$graffitiSession.value)"
                        class="pin-button"
                      >
                        {{ obj.value.pinned?'Unpin':'Pin' }}
                      </button>
                    </template>
                    <button
                      @click="toggleLikeMessage(obj,$graffitiSession.value)"
                      :class="['like-button', { liked: obj.value.liked }]"
                    >
                      {{ obj.value.liked ? 'Unlike' : 'Like' }}
                    </button>
                  </div>
                </li>
              </ul>

              <template v-if="chatType==='group'">
                <graffiti-discover
                  v-slot="{ objects: groupChatObjects }"
                  :channels="['designftw']"
                  :schema="{
                properties:{ value:{
                  required:['activity','object'],
                  properties:{
                    activity:{const:'Create'},
                    object:{
                      required:['type','channel'],
                      properties:{ type:{const:'Group Chat'}, channel:{type:'string'} }
                    }
                  }
                }}
              }"
                >
                  <div
                    v-if="groupChatObjects.some(o=>o.value.object.channel===activeChannel)"
                  >
                    <form
                      @submit.prevent="renameGroupChat($graffitiSession.value)"
                    >
                      <input
                        type="text"
                        v-model="rename"
                        placeholder="New group name"
                      />
                      <input type="submit" value="Rename Group" />
                    </form>
                  </div>
                </graffiti-discover>
              </template>
            </graffiti-discover>
          </div>

          <p v-else>Select a conversation to view messages.</p>
        </div>
      </div>
      <graffiti-discover
        v-model:objects="renameObjects"
        :channels="['designftw']"
        :schema="{
          properties:{ value:{
            required:['name','describes'],
            properties:{
              name:{type:'string'},
              describes:{type:'string'}
            }
          }}
        }"
      />
    </div>

    <script src="index.js" type="module"></script>
  </body>
</html>
